<!DOCTYPE html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>~Things are Inevitable~</title>
  <style>
    :root{ --bg:#0a0b10; --fg:#e8e8ff; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;overflow:hidden;touch-action:manipulation;-webkit-user-select:none;user-select:none}
    #stage{position:fixed;inset:0}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block;image-rendering:pixelated}
    #poetry{position:absolute;inset:0;z-index:3;pointer-events:none}
    .poem{position:absolute;font-weight:600;opacity:.92;mix-blend-mode:screen;text-shadow:0 2px 10px rgba(0,0,0,.45);max-width:85%;line-height:1.1;word-break:break-word;overflow-wrap:anywhere}
    .point{position:absolute;border:2px solid rgba(255,255,255,.9);z-index:4}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(0.85)}}
    @keyframes throb{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}
    @keyframes wobble{0%,100%{transform:rotate(0deg)}50%{transform:rotate(6deg)}}
    @keyframes jitter{0%,100%{transform:translate(0,0)}50%{transform:translate(1px,-1px)}}
    /* Anti-flash tone overlay */
    #tone{position:absolute;inset:0;z-index:2;pointer-events:none;background:rgba(0,0,0,0);transition:background 260ms ease}
    /* Overlay + footer */
    #overlay{position:absolute;inset:0;display:grid;place-items:center;background:radial-gradient(80% 60% at 50% 30%, rgba(255,255,255,.04), rgba(0,0,0,.55));color:#fff;z-index:6}
    #overlay .card{background:rgba(0,0,0,.42);border:1px solid rgba(255,255,255,.14);padding:14px 18px;border-radius:12px;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    #overlay button{margin-top:10px;background:#b896ff;border:0;color:#0a0b10;font-weight:700;padding:10px 16px;border-radius:10px;cursor:pointer}
    #credits{position:absolute;left:10px;right:10px;bottom:env(safe-area-inset-bottom,10px);height:24px;color:#cfd3ff;opacity:.78;font-size:11px;display:flex;align-items:center;justify-content:space-between;gap:8px;z-index:5}
    #credits span{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  </style>
</head>
<body>
  <div id="stage">
    <canvas id="gl"></canvas>
    <canvas id="img"></canvas>
    <div id="tone"></div>
    <div id="poetry"></div>
    <div id="p1" class="point" style="display:none"></div>
    <div id="p2" class="point" style="display:none"></div>
    <div id="overlay">
      <div class="card">
        <div><strong>Tap to begin</strong></div>
        <div style="opacity:.85;margin-top:6px">Audio unlocks on first tap. One or two dots per room. Tap anywhere to cut.</div>
        <button id="begin">Start</button>
      </div>
    </div>
    <div id="credits"><span id="creditText"></span><span id="roomText"></span></div>
  </div>

<script>
(function(){
  const glCanvas = document.getElementById('gl');
  const imgCanvas = document.getElementById('img');
  const poetryLayer = document.getElementById('poetry');
  const tone = document.getElementById('tone');
  const p1 = document.getElementById('p1');
  const p2 = document.getElementById('p2');
  const creditText = document.getElementById('creditText');
  const roomText = document.getElementById('roomText');
  const overlay = document.getElementById('overlay');
  const beginBtn = document.getElementById('begin');

  function fit(){ const r = document.getElementById('stage').getBoundingClientRect(); [glCanvas, imgCanvas].forEach(c=>{ c.width=r.width|0; c.height=r.height|0; }); }
  window.addEventListener('resize', fit, {passive:true}); fit();

  // ---------- AUDIO (profiles per room + pentatonic; major on bright; ping‑pong optional) ----------
  let ac, master, padBus, melBus, filter, verb, verbSend, delay, fb, started=false;
  let voices=[]; let vibratoLFO; let currentScale={root:220, major:true}; let melodyTimer=null;
  let ringGroup=null; let soundProfile={sine:true, saw:false, ring:false}; let forceScaleMode=null;
  // Ping‑pong
  let pp=null; let pingPongActive=false;

  function initAudio(){
    ac = new (window.AudioContext||window.webkitAudioContext)();
    master=ac.createGain(); master.gain.value=0.15; master.connect(ac.destination);
    padBus=ac.createGain(); padBus.gain.value=0.9; melBus=ac.createGain(); melBus.gain.value=0.95;
    filter=ac.createBiquadFilter(); filter.type='lowpass'; filter.frequency.value=2200; filter.Q.value=0.7;

    verb=ac.createConvolver(); verb.buffer=makeReverbImpulse(ac, 4.2, 4.2);
    verbSend=ac.createGain(); verbSend.gain.value=0.42; // wetter for ring
    delay=ac.createDelay(1.3); delay.delayTime.value=0.42+Math.random()*0.2;
    fb=ac.createGain(); fb.gain.value=0.24; delay.connect(fb); fb.connect(delay);

    padBus.connect(filter); melBus.connect(filter); filter.connect(master);
    padBus.connect(verbSend); melBus.connect(verbSend); verbSend.connect(verb); verb.connect(master);
    melBus.connect(delay); delay.connec
